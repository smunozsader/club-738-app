rules_version = '2';

// ============================================================================
// FIRESTORE SECURITY RULES - Club 738
// ============================================================================
// PRINCIPIO: Mínimo privilegio - cada usuario solo accede a sus propios datos
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    // Verificar que el usuario esté autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar que el usuario accede a su propio documento
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }
    
    // Verificar que el email del documento coincide con el usuario autenticado
    function isOwnDocument() {
      return isAuthenticated() && request.auth.token.email.lower() == resource.id.lower();
    }
    
    // Verificar que el usuario está creando su propio documento
    function isCreatingOwnDocument(docId) {
      return isAuthenticated() && request.auth.token.email.lower() == docId.lower();
    }
    
    // Verificar si es el Secretario (tiene permisos de lectura de todos los socios)
    function isSecretario() {
      return isAuthenticated() && request.auth.token.email == 'admin@club738.com';
    }
    
    // Verificar si es el Administrador (permisos completos de edición)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'admin@club738.com';
    }
    
    // Verificar si es Secretario O Administrador (ambos tienen permisos administrativos)
    function isAdminOrSecretary() {
      return isAdmin() || isSecretario();
    }
    
    // ========================================================================
    // COLECCIÓN: socios
    // ========================================================================
    // Cada socio solo puede leer/escribir su propio documento
    // El Secretario puede leer todos los documentos para el panel de cobranza
    // El documento ID es el email del socio
    
    match /socios/{email} {
      // Lectura: el propio socio O el secretario/admin pueden leer
      allow read: if isOwner(email) || isAdminOrSecretary();
      
      // Escritura: solo el propio socio puede actualizar sus datos
      // El admin puede editar CUALQUIER campo (nombre, CURP, domicilio, etc.)
      // El secretario puede actualizar campos de renovación y pagos
      allow update: if isOwner(email) 
        // Campos que el usuario puede actualizar
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['documentosPETA', 'bienvenidaVista', 'fechaBienvenida', 'telefono', 'domicilio'])
        || isAdmin()  // Admin puede editar TODO
        || isSecretario();  // Secretario puede editar pagos/membresía
      
      // No permitir delete desde cliente
      allow delete: if false;
      
      // Crear solo si no existe y es el propio usuario
      allow create: if isCreatingOwnDocument(email);
      
      // ======================================================================
      // SUBCOLECCIÓN: armas
      // ======================================================================
      // Cada socio puede leer sus propias armas
      // El admin puede CREAR, EDITAR y ELIMINAR armas (gestión completa)
      // El secretario puede leer y actualizar modalidades
      
      match /armas/{armaId} {
        allow read: if isOwner(email) || isAdminOrSecretary();
        
        // Admin puede CREAR armas manualmente
        allow create: if isAdmin();
        
        // Admin puede actualizar cualquier campo, Secretario solo modalidad
        allow update: if isAdmin() 
          || (isSecretario() && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['modalidad']));
        
        // Admin puede ELIMINAR armas (con log de auditoría en código)
        allow delete: if isAdmin();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: solicitudesAlta
      // ======================================================================
      // Solicitudes de alta de armas nuevas (compra, herencia, etc.)
      // El socio SOLICITA el alta, el Secretario la APRUEBA y REGISTRA
      
      match /solicitudesAlta/{solicitudId} {
        // Lectura: el socio puede ver sus propias solicitudes O el secretario puede ver todas
        allow read: if isOwner(email) || isAdminOrSecretary();
        
        // Creación: el socio puede crear solicitudes con estado inicial 'pendiente'
        allow create: if isOwner(email) && 
          request.resource.data.estado == 'pendiente' &&
          request.resource.data.solicitadoPor == email;
        
        // Actualización: SOLO el admin/secretario pueden cambiar el estado
        // (aprobar, procesar, rechazar)
        allow update: if isAdminOrSecretary();
        
        // Eliminación: SOLO el admin/secretario pueden eliminar solicitudes
        allow delete: if isAdminOrSecretary();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: solicitudesBaja
      // ======================================================================
      // Solicitudes de baja de armas (venta, transferencia, robo, etc.)
      // El socio SOLICITA la baja, el Secretario la APRUEBA y PROCESA
      
      match /solicitudesBaja/{solicitudId} {
        // Lectura: el socio puede ver sus propias solicitudes O el secretario puede ver todas
        allow read: if isOwner(email) || isAdminOrSecretary();
        
        // Creación: el socio puede crear solicitudes con estado inicial 'pendiente'
        allow create: if isOwner(email) && 
          request.resource.data.estado == 'pendiente' &&
          request.resource.data.solicitadoPor == email;
        
        // Actualización: SOLO el admin/secretario pueden cambiar el estado
        // (aprobar, procesar, rechazar)
        allow update: if isAdminOrSecretary();
        
        // Eliminación: SOLO el admin/secretario pueden eliminar solicitudes
        allow delete: if isAdminOrSecretary();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: petas
      // ======================================================================
      // Solicitudes de PETA (Permiso Extraordinario Transportación de Armas)
      // El socio CREA la solicitud, el Secretario la VERIFICA y GENERA el PDF
      
      match /petas/{petaId} {
        // Lectura: el socio puede ver sus propias PETAs O el secretario puede ver todas
        allow read: if isOwner(email) || isAdminOrSecretary();
        
        // Creación: el socio puede crear solicitudes PETA en su propia colección
        allow create: if isOwner(email);
        
        // Actualización: el socio puede actualizar sus PETAs en estado 'documentacion_proceso'
        // El secretario/admin pueden actualizar cualquier PETA (verificación, cambio de estado)
        allow update: if (isOwner(email) && resource.data.estado == 'documentacion_proceso')
          || isAdminOrSecretary();
        
        // Eliminación: SOLO el secretario/admin pueden eliminar PETAs
        allow delete: if isAdminOrSecretary();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: notificaciones
      // ======================================================================
      // Notificaciones del admin/secretario hacia los socios
      // El socio puede leer y marcar como leídas
      // El admin/secretario pueden crear notificaciones
      
      match /notificaciones/{notifId} {
        // Lectura: el propio socio O el admin/secretario pueden leer
        allow read: if isOwner(email) || isAdminOrSecretary();
        
        // Creación: SOLO el admin/secretario pueden crear notificaciones
        allow create: if isAdminOrSecretary();
        
        // Actualización: el socio puede marcar como leída, admin puede editar
        allow update: if isOwner(email) 
          && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['estado', 'fechaLeida'])
          || isAdminOrSecretary();
        
        // Eliminación: SOLO el admin puede eliminar notificaciones
        allow delete: if isAdmin();
      }
    }
    
    // ========================================================================
    // COLECCIÓN: usuarios
    // ========================================================================
    // Define roles y permisos diferenciados (administrator, socio)
    // Solo lectura para verificar roles, escritura solo por backend
    
    match /usuarios/{email} {
      // Lectura: cada usuario puede leer su propio documento
      allow read: if isAuthenticated() && request.auth.token.email.lower() == email.lower();
      
      // Escritura: SOLO por backend (Admin SDK)
      allow write: if false;
    }
    
    // ========================================================================
    // COLECCIÓN: auditoria
    // ========================================================================
    // Log de acciones administrativas (eliminación docs, edición armas, etc.)
    // Solo el admin puede crear registros, todos pueden leer
    
    match /auditoria/{auditId} {
      // Lectura: admin y secretario pueden leer logs
      allow read: if isAdminOrSecretary();
      
      // Creación: admin y secretario pueden crear logs de auditoría
      allow create: if isAdminOrSecretary();
      
      // Actualización/Eliminación: nadie puede modificar logs (inmutables)
      allow update, delete: if false;
    }
    
    // ========================================================================
    // COLECCIÓN: citas
    // ========================================================================
    // Agendamiento de citas con el secretario
    // Los socios pueden crear/leer/actualizar sus propias citas
    // El secretario puede leer/actualizar todas las citas
    
    match /citas/{citaId} {
      // Lectura: el socio que creó la cita O el secretario pueden leer
      allow read: if isAuthenticated();
      
      // Creación: cualquier socio autenticado puede crear citas
      allow create: if isAuthenticated();
      
      // Actualización: el secretario puede actualizar todas las citas
      // Los socios NO pueden actualizar sus citas (están bloqueadas)
      allow update: if isAdminOrSecretary();
      
      // Eliminación: SOLO el secretario puede eliminar citas
      allow delete: if isAdminOrSecretary();
    }
    
    // ========================================================================
    // COLECCIÓN: bajas
    // ========================================================================
    // Registro global de bajas procesadas (historial administrativo)
    // SOLO el secretario puede escribir aquí
    
    match /bajas/{bajaId} {
      // Lectura: todos los socios pueden consultar el historial público de bajas
      allow read: if isAuthenticated();
      
      // Escritura: SOLO el admin/secretario pueden crear/actualizar/eliminar bajas procesadas
      allow create, update, delete: if isAdminOrSecretary();
    }
    
    // ========================================================================
    // COLECCIÓN: notificaciones
    // ========================================================================
    // Sistema de notificaciones para socios
    // Admin/Secretario pueden crear notificaciones para cualquier socio
    // Cada socio puede leer solo sus notificaciones y marcarlas como leídas
    
    match /notificaciones/{notifId} {
      // Lectura: solo el socio destinatario puede leer sus notificaciones
      allow read: if isAuthenticated() 
        && request.auth.token.email.lower() == resource.data.socioEmail.lower();
      
      // Creación: solo admin/secretario pueden crear notificaciones
      allow create: if isAdminOrSecretary()
        && request.resource.data.keys().hasAll(['socioEmail', 'tipo', 'titulo', 'mensaje', 'leido', 'fechaCreacion'])
        && request.resource.data.tipo in ['info', 'warning', 'success', 'error'];
      
      // Actualización: el socio puede marcar sus notificaciones como leídas
      // Admin/Secretario pueden actualizar cualquier notificación
      allow update: if (isAuthenticated() 
          && request.auth.token.email.lower() == resource.data.socioEmail.lower()
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['leido', 'fechaLeido']))
        || isAdminOrSecretary();
      
      // Eliminación: solo admin/secretario pueden eliminar notificaciones
      allow delete: if isAdminOrSecretary();
    }
    
    // ========================================================================
    // COLECCIÓN: admin (para futuros roles de administrador)
    // ========================================================================
    match /admin/{document=**} {
      allow read, write: if false; // Solo acceso por backend
    }
    
    // ========================================================================
    // REGLA DEFAULT: Denegar todo lo demás
    // ========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
