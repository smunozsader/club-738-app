rules_version = '2';

// ============================================================================
// FIRESTORE SECURITY RULES - Club 738
// ============================================================================
// PRINCIPIO: Mínimo privilegio - cada usuario solo accede a sus propios datos
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    // Verificar que el usuario esté autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar que el usuario accede a su propio documento
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }
    
    // Verificar que el email del documento coincide con el usuario autenticado
    function isOwnDocument() {
      return isAuthenticated() && request.auth.token.email.lower() == resource.id.lower();
    }
    
    // Verificar que el usuario está creando su propio documento
    function isCreatingOwnDocument(docId) {
      return isAuthenticated() && request.auth.token.email.lower() == docId.lower();
    }
    
    // Verificar si es el Secretario (tiene permisos de lectura de todos los socios)
    function isSecretario() {
      return isAuthenticated() && request.auth.token.email == 'smunozam@gmail.com';
    }
    
    // ========================================================================
    // COLECCIÓN: socios
    // ========================================================================
    // Cada socio solo puede leer/escribir su propio documento
    // El Secretario puede leer todos los documentos para el panel de cobranza
    // El documento ID es el email del socio
    
    match /socios/{email} {
      // Lectura: el propio socio O el secretario pueden leer
      allow read: if isOwner(email) || isSecretario();
      
      // Escritura: solo el propio socio puede actualizar sus datos
      // El secretario puede actualizar campos de renovación y pagos
      allow update: if isOwner(email) 
        // Campos que el usuario puede actualizar
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['documentosPETA', 'bienvenidaVista', 'fechaBienvenida', 'telefono', 'domicilio'])
        || isSecretario();
        // Secretario puede actualizar cualquier campo (pagos, membresía, etc.)
      
      // No permitir delete desde cliente
      allow delete: if false;
      
      // Crear solo si no existe y es el propio usuario
      allow create: if isCreatingOwnDocument(email);
      
      // ======================================================================
      // SUBCOLECCIÓN: armas
      // ======================================================================
      // Cada socio puede leer sus propias armas
      // El secretario puede leer y actualizar las armas (para asignar modalidad)
      // No permitir crear/eliminar desde cliente
      
      match /armas/{armaId} {
        allow read: if isOwner(email) || isSecretario();
        // Secretario puede actualizar modalidad de armas
        allow update: if isSecretario() 
          && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['modalidad']);
        allow create, delete: if false; // Solo admin puede crear/eliminar armas
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: solicitudesAlta
      // ======================================================================
      // Solicitudes de alta de armas nuevas (compra, herencia, etc.)
      // El socio SOLICITA el alta, el Secretario la APRUEBA y REGISTRA
      
      match /solicitudesAlta/{solicitudId} {
        // Lectura: el socio puede ver sus propias solicitudes O el secretario puede ver todas
        allow read: if isOwner(email) || isSecretario();
        
        // Creación: el socio puede crear solicitudes con estado inicial 'pendiente'
        allow create: if isOwner(email) && 
          request.resource.data.estado == 'pendiente' &&
          request.resource.data.solicitadoPor == email;
        
        // Actualización: SOLO el secretario puede cambiar el estado
        // (aprobar, procesar, rechazar)
        allow update: if isSecretario();
        
        // Eliminación: SOLO el secretario puede eliminar solicitudes
        allow delete: if isSecretario();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: solicitudesBaja
      // ======================================================================
      // Solicitudes de baja de armas (venta, transferencia, robo, etc.)
      // El socio SOLICITA la baja, el Secretario la APRUEBA y PROCESA
      
      match /solicitudesBaja/{solicitudId} {
        // Lectura: el socio puede ver sus propias solicitudes O el secretario puede ver todas
        allow read: if isOwner(email) || isSecretario();
        
        // Creación: el socio puede crear solicitudes con estado inicial 'pendiente'
        allow create: if isOwner(email) && 
          request.resource.data.estado == 'pendiente' &&
          request.resource.data.solicitadoPor == email;
        
        // Actualización: SOLO el secretario puede cambiar el estado
        // (aprobar, procesar, rechazar)
        allow update: if isSecretario();
        
        // Eliminación: SOLO el secretario puede eliminar solicitudes
        allow delete: if isSecretario();
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: petas
      // ======================================================================
      // Solicitudes de PETA (Permiso Extraordinario Transportación de Armas)
      // El socio CREA la solicitud, el Secretario la VERIFICA y GENERA el PDF
      
      match /petas/{petaId} {
        // Lectura: el socio puede ver sus propias PETAs O el secretario puede ver todas
        allow read: if isOwner(email) || isSecretario();
        
        // Creación: el socio puede crear solicitudes PETA
        allow create: if isOwner(email) && 
          request.resource.data.creadoPor == email;
        
        // Actualización: el socio puede actualizar sus PETAs en estado 'documentacion_proceso'
        // El secretario puede actualizar cualquier PETA (verificación, cambio de estado)
        allow update: if (isOwner(email) && resource.data.estado == 'documentacion_proceso')
          || isSecretario();
        
        // Eliminación: SOLO el secretario puede eliminar PETAs
        allow delete: if isSecretario();
      }
    }
    
    // ========================================================================
    // COLECCIÓN: citas
    // ========================================================================
    // Agendamiento de citas con el secretario
    // Los socios pueden crear/leer/actualizar sus propias citas
    // El secretario puede leer/actualizar todas las citas
    
    match /citas/{citaId} {
      // Lectura: el socio que creó la cita O el secretario pueden leer
      allow read: if isAuthenticated() && 
        (request.auth.token.email.lower() == resource.data.socioEmail.lower() || isSecretario());
      
      // Creación: cualquier socio autenticado puede crear citas
      allow create: if isAuthenticated() && 
        request.resource.data.socioEmail.lower() == request.auth.token.email.lower();
      
      // Actualización: el secretario puede actualizar todas las citas
      // Los socios NO pueden actualizar sus citas (están bloqueadas)
      allow update: if isSecretario();
      
      // Eliminación: SOLO el secretario puede eliminar citas
      allow delete: if isSecretario();
    }
    
    // ========================================================================
    // COLECCIÓN: bajas
    // ========================================================================
    // Registro global de bajas procesadas (historial administrativo)
    // SOLO el secretario puede escribir aquí
    
    match /bajas/{bajaId} {
      // Lectura: todos los socios pueden consultar el historial público de bajas
      allow read: if isAuthenticated();
      
      // Escritura: SOLO el secretario puede crear/actualizar/eliminar bajas procesadas
      allow create, update, delete: if isSecretario();
    }
    
    // ========================================================================
    // COLECCIÓN: admin (para futuros roles de administrador)
    // ========================================================================
    match /admin/{document=**} {
      allow read, write: if false; // Solo acceso por backend
    }
    
    // ========================================================================
    // REGLA DEFAULT: Denegar todo lo demás
    // ========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
