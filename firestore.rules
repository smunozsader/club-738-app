rules_version = '2';

// ============================================================================
// FIRESTORE SECURITY RULES - Club 738
// ============================================================================
// PRINCIPIO: Mínimo privilegio - cada usuario solo accede a sus propios datos
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    // Verificar que el usuario esté autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar que el usuario accede a su propio documento
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }
    
    // Verificar que el email del documento coincide con el usuario autenticado
    function isOwnDocument() {
      return isAuthenticated() && request.auth.token.email.lower() == resource.id.lower();
    }
    
    // Verificar que el usuario está creando su propio documento
    function isCreatingOwnDocument(docId) {
      return isAuthenticated() && request.auth.token.email.lower() == docId.lower();
    }
    
    // Verificar si es el Secretario (tiene permisos de lectura de todos los socios)
    function isSecretario() {
      return isAuthenticated() && request.auth.token.email == 'smunozam@gmail.com';
    }
    
    // ========================================================================
    // COLECCIÓN: socios
    // ========================================================================
    // Cada socio solo puede leer/escribir su propio documento
    // El Secretario puede leer todos los documentos para el panel de cobranza
    // El documento ID es el email del socio
    
    match /socios/{email} {
      // Lectura: el propio socio O el secretario pueden leer
      allow read: if isOwner(email) || isSecretario();
      
      // Escritura: solo el propio socio puede actualizar sus datos
      // El secretario puede actualizar campos de renovación y pagos
      allow update: if isOwner(email) 
        // Campos que el usuario puede actualizar
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['documentosPETA', 'bienvenidaVista', 'fechaBienvenida', 'telefono', 'domicilio'])
        || isSecretario();
        // Secretario puede actualizar cualquier campo (pagos, membresía, etc.)
      
      // No permitir delete desde cliente
      allow delete: if false;
      
      // Crear solo si no existe y es el propio usuario
      allow create: if isCreatingOwnDocument(email);
      
      // ======================================================================
      // SUBCOLECCIÓN: armas
      // ======================================================================
      // Cada socio puede leer sus propias armas
      // El secretario puede leer y actualizar las armas (para asignar modalidad)
      // No permitir crear/eliminar desde cliente
      
      match /armas/{armaId} {
        allow read: if isOwner(email) || isSecretario();
        // Secretario puede actualizar modalidad de armas
        allow update: if isSecretario() 
          && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['modalidad']);
        allow create, delete: if false; // Solo admin puede crear/eliminar armas
      }
      
      // ======================================================================
      // SUBCOLECCIÓN: petas
      // ======================================================================
      // Cada socio puede leer/crear sus propias solicitudes PETA
      // El secretario puede leer y actualizar todas las PETAs
      
      match /petas/{petaId} {
        allow read: if isOwner(email) || isSecretario();
        allow create: if isOwner(email);
        allow update: if isOwner(email) || isSecretario();
        allow delete: if false; // No permitir eliminar solicitudes
      }
    }
    
    // ========================================================================
    // COLECCIÓN: admin (para futuros roles de administrador)
    // ========================================================================
    match /admin/{document=**} {
      allow read, write: if false; // Solo acceso por backend
    }
    
    // ========================================================================
    // REGLA DEFAULT: Denegar todo lo demás
    // ========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
