rules_version = '2';

// ============================================================================
// FIRESTORE SECURITY RULES - Club 738
// ============================================================================
// PRINCIPIO: Mínimo privilegio - cada usuario solo accede a sus propios datos
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    // Verificar que el usuario esté autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar que el usuario accede a su propio documento
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }
    
    // Verificar que el email del documento coincide con el usuario autenticado
    function isOwnDocument() {
      return isAuthenticated() && request.auth.token.email.lower() == resource.id.lower();
    }
    
    // Verificar que el usuario está creando su propio documento
    function isCreatingOwnDocument(docId) {
      return isAuthenticated() && request.auth.token.email.lower() == docId.lower();
    }
    
    // Verificar si es el Secretario (tiene permisos de lectura de todos los socios)
    function isSecretario() {
      return isAuthenticated() && request.auth.token.email == 'smunozam@gmail.com';
    }
    
    // ========================================================================
    // COLECCIÓN: socios
    // ========================================================================
    // Cada socio solo puede leer/escribir su propio documento
    // El Secretario puede leer todos los documentos para el panel de cobranza
    // El documento ID es el email del socio
    
    match /socios/{email} {
      // Lectura: el propio socio O el secretario pueden leer
      allow read: if isOwner(email) || isSecretario();
      
      // Escritura: solo el propio socio puede actualizar sus datos
      // El secretario puede actualizar campos de renovación
      allow update: if isOwner(email) 
        // Campos que el usuario puede actualizar
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['documentosPETA', 'bienvenidaVista', 'telefono', 'domicilio'])
        || isSecretario()
        // Campos que el secretario puede actualizar
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['renovacion2026']);
      
      // No permitir delete desde cliente
      allow delete: if false;
      
      // Crear solo si no existe y es el propio usuario
      allow create: if isCreatingOwnDocument(email);
      
      // ======================================================================
      // SUBCOLECCIÓN: armas
      // ======================================================================
      // Cada socio puede leer sus propias armas
      // El secretario puede leer las armas de cualquier socio
      // No permitir crear/modificar/eliminar desde cliente
      
      match /armas/{armaId} {
        allow read: if isOwner(email) || isSecretario();
        allow write: if false; // Solo admin puede modificar armas
      }
    }
    
    // ========================================================================
    // COLECCIÓN: admin (para futuros roles de administrador)
    // ========================================================================
    match /admin/{document=**} {
      allow read, write: if false; // Solo acceso por backend
    }
    
    // ========================================================================
    // REGLA DEFAULT: Denegar todo lo demás
    // ========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
